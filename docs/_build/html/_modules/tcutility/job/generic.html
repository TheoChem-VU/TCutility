
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tcutility.job.generic &#8212; TCutility v0.16.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=45421911"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/tcutility/job/generic';</script>
    <link rel="icon" href="https://avatars.githubusercontent.com/u/119413491"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item"><!-- _templates/logo.html -->
<style>
    .myDiv {
      color: #323232;
      font-size: 30px;
      font-weight: 400;
      line-height: : 33px;
      text-decoration: none;
    }
</style>
<div class="myDiv">
    <a href="/index.html">
        <img src="https://avatars.githubusercontent.com/u/119413491?s=60&v=4">
        TCutility
    </a>
</div></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><!-- _templates/star.html -->
<a href=https://github.com/TheoChem-VU><i class="fa-brands fa-github"></i> TheoCheM</a></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><!-- _templates/star.html -->
<a href=https://github.com/TheoChem-VU><i class="fa-brands fa-github"></i> TheoCheM</a></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../tcutility.html" class="nav-link">tcutility</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">tcutility.job.generic</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for tcutility.job.generic</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stat</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dictfunc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scm</span><span class="w"> </span><span class="kn">import</span> <span class="n">plams</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tcutility</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">slurm</span><span class="p">,</span> <span class="n">connect</span><span class="p">,</span> <span class="n">cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tcutility.environment</span><span class="w"> </span><span class="kn">import</span> <span class="n">OSName</span><span class="p">,</span> <span class="n">get_os_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tcutility.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">TCJobError</span>

<span class="n">j</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

<span class="nd">@cache</span><span class="o">.</span><span class="n">cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_python_path</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="n">connect</span><span class="o">.</span><span class="n">Server</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">Local</span><span class="p">()):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sometimes it is necessary to have the Python path as some environments don&#39;t have its path.</span>
<span class="sd">    This function attempts to find the Python path and returns it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">python</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">python</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;which python&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sp</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
        <span class="n">python</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">python</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">server</span><span class="o">.</span><span class="n">path_exists</span><span class="p">(</span><span class="n">python</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">python</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;which python3&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sp</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="n">python</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># we default to the python executable</span>
    <span class="k">if</span> <span class="n">python</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">server</span><span class="o">.</span><span class="n">path_exists</span><span class="p">(</span><span class="n">python</span><span class="p">):</span>
        <span class="n">python</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>

    <span class="k">return</span> <span class="n">python</span>


<div class="viewcode-block" id="Job">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Job</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the base Job class used to build more advanced classes such as :class:`AMSJob &lt;tcutility.job.ams.AMSJob&gt;` and :class:`ORCAJob &lt;tcutility.job.orca.ORCAJob&gt;`.</span>
<span class="sd">    The base class contains an empty :class:`Result &lt;tcutility.results.result.Result&gt;` object that holds the settings.</span>
<span class="sd">    It also provides :meth:`__enter__` and :meth:`__exit__` methods to make use of context manager syntax.</span>

<span class="sd">    All class methods are in principle safe to overwrite, but the :meth:`_setup_job` method **must** be overwritten.</span>

<span class="sd">    Args:</span>
<span class="sd">        test_mode: whether to enable the testing mode. If enabled, the job will be setup like normally, but the running step is skipped. This is useful if you want to know what the job settings look like before running the real calculations.</span>
<span class="sd">        overwrite: whether to overwrite a previously run job in the same working directory.</span>
<span class="sd">        wait_for_finish: whether to wait for this job to finish running before continuing your runscript.</span>
<span class="sd">        delete_on_finish: whether to remove the workdir for this job after it is finished running.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">base_jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Job&quot;</span><span class="p">],</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wait_for_finish</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">delete_on_finish</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">delete_on_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_slurm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">Result</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_molecule_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;calc&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rundir</span> <span class="o">=</span> <span class="s2">&quot;tmp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preambles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postambles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postscripts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_servers</span> <span class="o">=</span> <span class="p">[</span><span class="n">connect</span><span class="o">.</span><span class="n">Local</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_server</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="n">test_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_finish</span> <span class="o">=</span> <span class="n">wait_for_finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_on_finish</span> <span class="o">=</span> <span class="n">delete_on_finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_slurm</span> <span class="o">=</span> <span class="n">use_slurm</span>

        <span class="c1"># update this job with base_jobs</span>
        <span class="k">for</span> <span class="n">base_job</span> <span class="ow">in</span> <span class="n">base_jobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base_job</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="k">if</span> <span class="n">test_mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">test_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_finish</span> <span class="k">if</span> <span class="n">wait_for_finish</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">wait_for_finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_on_finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_on_finish</span> <span class="k">if</span> <span class="n">delete_on_finish</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">delete_on_finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_on_fail</span> <span class="o">=</span> <span class="n">delete_on_fail</span> <span class="k">if</span> <span class="n">delete_on_fail</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">delete_on_fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_slurm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_slurm</span> <span class="k">if</span> <span class="n">use_slurm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">use_slurm</span>

        <span class="c1"># self.server = connect.get_current_server()</span>
        <span class="c1"># if self.server != connect.Local:</span>
        <span class="c1">#     self.sbatch(**self.server.sbatch_defaults)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">exc_tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Job set-up failed with exception: </span><span class="si">{</span><span class="n">exc_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">exc_value</span><span class="si">}</span><span class="s1">) in File &quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&quot;, line </span><span class="si">{</span><span class="n">exc_tb</span><span class="o">.</span><span class="n">tb_lineno</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_select_server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">connect</span><span class="o">.</span><span class="n">Server</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a server to run on based on the currently selected servers and their weights, </span>
<span class="sd">        this will only choose a server once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_weights</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_weights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selected_server</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_servers</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_server</span><span class="o">.</span><span class="n">sbatch_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_server</span>

<div class="viewcode-block" id="Job.can_skip">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.can_skip">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the job can be skipped. We check this by loading the calculation and checking if the job status was fatal.</span>
<span class="sd">        Fatal in this case means that the job failed, canceled or could not be found. In those cases we want to run the job.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method works for the :class:`ADFJob &lt;tcutility.job.adf.ADFJob&gt;`, :class:`ADFFragmentJob &lt;tcutility.job.adf.ADFFragmentJob&gt;`,</span>
<span class="sd">            :class:`DFTBJob &lt;tcutility.job.dftb.DFTBJob&gt;` and :class:`ORCAJob &lt;tcutility.job.orca.ORCAJob&gt;` objects, but not</span>
<span class="sd">            yet for :class:`CRESTJob &lt;tcutility.job.crest.CRESTJob&gt;` and :class:`QCGJob &lt;tcutility.job.crest.QCGJob&gt;`. For the latter objects the job will always be rerun.</span>
<span class="sd">            This will be fixed in a later version of TCutility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">connect</span><span class="o">.</span><span class="n">Local</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">quick_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">fatal</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tcutility read -s </span><span class="si">{</span><span class="n">j</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">pwd</span><span class="p">(),</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SUCCESS&#39;</span><span class="p">,</span> <span class="s1">&#39;SUCCESS(W)&#39;</span><span class="p">,</span> <span class="s1">&#39;COMPLETING&#39;</span><span class="p">,</span> <span class="s1">&#39;CONFIGURING&#39;</span><span class="p">,</span> <span class="s1">&#39;PENDING&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Job.in_queue">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.in_queue">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the job is currently managed by slurm.</span>
<span class="sd">        We check this by loading the calculation and checking if the job status is &#39;RUNNING&#39;, &#39;COMPLETING&#39;, &#39;CONFIGURING&#39; or &#39;PENDING&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">quick_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLETING&quot;</span><span class="p">,</span> <span class="s2">&quot;CONFIGURING&quot;</span><span class="p">,</span> <span class="s2">&quot;PENDING&quot;</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">(name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, rundir=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="si">}</span><span class="s2">)&quot;</span>

<div class="viewcode-block" id="Job.sbatch">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.sbatch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sbatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change slurm settings, for example, to change the partition or change the number of cores to use.</span>
<span class="sd">        The arguments are the same as you would use for sbatch (`see sbatch manual &lt;https://slurm.schedmd.com/sbatch.html&gt;`_). E.g. to change the partition to &#39;tc&#39; call:</span>

<span class="sd">        ``job.sbatch(p=&#39;tc&#39;)`` or ``job.sbatch(partition=&#39;tc&#39;)``.</span>

<span class="sd">        Flags can be set as arguments with a boolean to enable or disable them:</span>

<span class="sd">        ``job.sbatch(exclusive=True)`` will set the ``--exclusive`` flag.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Note that some sbatch options, such as ``--job-name`` contain a dash, which cannot be used in Python arguments.</span>
<span class="sd">            To use these options you should use an underscore, like ``job.sbatch(job_name=&#39;water_dimer_GO&#39;)``.</span>

<span class="sd">        .. note::</span>

<span class="sd">            When running the job using sbatch we add a few extra default options:</span>

<span class="sd">            * ``-D/--chdir {self.workdir}``                to make sure the job starts in the correct directory</span>
<span class="sd">            * ``-J/--job-name {self.rundir}/{self.name}``  to give a nicer job-name when calling squeue</span>
<span class="sd">            * ``-o/--output {self.name}.out``              to redirect the output from the default slurm-{id}.out</span>

<span class="sd">            You can still overwrite them if you wish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dependency&quot;</span> <span class="ow">and</span> <span class="s2">&quot;dependency&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="p">[</span><span class="s2">&quot;dependency&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the current job. This method should create the working directory, runscript and input file.</span>
<span class="sd">        Method must return True if it was successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You must implement the _setup_job method in your subclass.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Job.run">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run this job. We detect if we are using slurm. If we are we submit this job using sbatch. Otherwise, we will run the job locally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_skip</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping calculation </span><span class="si">{</span><span class="n">j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">, it is already finished or currently pending or running.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_server</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
            <span class="n">server</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="c1"># write the post-script calls to the post-ambles:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_on_finish</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_postamble</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -r </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_on_fail</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_postamble</span><span class="p">(</span><span class="s2">&quot;# this will delete the calculation if it failed&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_postamble</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if [[ `tcutility read -s </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="si">}</span><span class="s2">` = FAILED || `tcutility read -s </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="si">}</span><span class="s2">` = UNKNOWN ]]; then rm -r </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="si">}</span><span class="s2">; fi;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">postscript</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscripts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postambles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_python_path</span><span class="p">(</span><span class="n">server</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">postscript</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">postscript</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># setup the job and check if it was successfull</span>
        <span class="n">setup_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_job</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setup_success</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">slurm</span><span class="o">.</span><span class="n">has_slurm</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_slurm</span><span class="p">:</span>
            <span class="c1"># set some default sbatch settings</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;chdir&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.out&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>

            <span class="c1"># submit the job with sbatch</span>
            <span class="n">sbatch_result</span> <span class="o">=</span> <span class="n">slurm</span><span class="o">.</span><span class="n">sbatch</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runfile_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_sbatch</span><span class="p">)</span>

            <span class="c1"># store the slurm job ID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_id</span> <span class="o">=</span> <span class="n">sbatch_result</span><span class="o">.</span><span class="n">id</span>
            <span class="c1"># and write the command to a file so we can rerun it later</span>
            <span class="k">with</span> <span class="n">server</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;submit.sh&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">cmd_file</span><span class="p">:</span>
                <span class="n">cmd_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sbatch_result</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
            <span class="c1"># make the submit command executable</span>
            <span class="n">server</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="mi">744</span><span class="p">,</span> <span class="n">j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;submit.sh&quot;</span><span class="p">))</span>

            <span class="c1"># if we requested the job to hold we will wait for the slurm job to finish</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_finish</span><span class="p">:</span>
                <span class="n">slurm</span><span class="o">.</span><span class="n">wait_for_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_id</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os_name</span> <span class="o">=</span> <span class="n">get_os_name</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os_name</span> <span class="o">==</span> <span class="n">OSName</span><span class="o">.</span><span class="n">WINDOWS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TCJobError</span><span class="p">(</span><span class="s2">&quot;Generic Job&quot;</span><span class="p">,</span> <span class="s2">&quot;Running jobs on Windows is not supported.&quot;</span><span class="p">)</span>

            <span class="c1"># if we are not using slurm, we can execute the file. For this we need special permissions, so we have to set that first.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runfile_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runfile_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IEXEC</span><span class="p">)</span>

            <span class="n">runfile_dir</span><span class="p">,</span> <span class="n">runscript</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runfile_path</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./&quot;</span> <span class="o">+</span> <span class="n">runscript</span><span class="p">]</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;posix&quot;</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="n">runscript</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> in directory: </span><span class="si">{</span><span class="n">runfile_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runfile_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.out&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">runfile_dir</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Job.add_preamble">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.add_preamble">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_preamble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a preamble for the runscript. This should come after the shebang, but before the calculation is ran by the program (ADF or ORCA).</span>
<span class="sd">        This can used, for example, to load some modules. E.g. to load a specific version of AMS we can call:</span>
<span class="sd">        job.add_preamble(&#39;module load ams/2023.101&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preambles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="Job.add_postamble">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.add_postamble">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_postamble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a postamble for the runscript. This should come after the calculation is ran by the program (ADF or ORCA).</span>
<span class="sd">        This can be used, for example, to remove or copy some files. E.g. to remove all t12.* files we can call:</span>
<span class="sd">        job.add_postamble(&#39;rm t12.*&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postambles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="Job.add_postscript">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.add_postscript">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_postscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a post-script to this calculation.</span>
<span class="sd">        This should be either a Python module with a __file__ attribute or the path to a Python script.</span>
<span class="sd">        The post-script will be called with Python and any given args will be added as arguments when calling the script.</span>

<span class="sd">        Args:</span>
<span class="sd">            script: a Python object with a __file__ attribute or the file-path to a script.</span>
<span class="sd">            *args: positional arguments to pass to the post-script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postscripts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">script</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span></div>


<div class="viewcode-block" id="Job.dependency">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.dependency">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otherjob</span><span class="p">:</span> <span class="s2">&quot;Job&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a dependency between this job and otherjob.</span>
<span class="sd">        This means that this job will run after the other job is finished running succesfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">otherjob</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">can_skip</span><span class="p">(),</span> <span class="n">otherjob</span><span class="o">.</span><span class="n">in_queue</span><span class="p">(),</span> <span class="n">otherjob</span><span class="o">.</span><span class="n">slurm_job_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="c1"># if otherjob.can_skip() and not otherjob.in_queue():</span>
        <span class="c1">#     return</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">otherjob</span><span class="p">,</span> <span class="s2">&quot;slurm_job_id&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sbatch</span><span class="p">(</span><span class="n">dependency</span><span class="o">=</span><span class="n">otherjob</span><span class="o">.</span><span class="n">slurm_job_id</span><span class="p">)</span></div>

            <span class="c1"># self.sbatch(kill_on_invalid_dep=&quot;Yes&quot;)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The working directory of this job. All important files are written here, for example the input file and runscript.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_server</span><span class="p">()</span><span class="o">.</span><span class="n">pwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">runfile_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The file path to the runscript of this job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.run&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inputfile_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The file path to the input file of this job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">j</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.in&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_mol_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method should return the name of the output molecule if it makes sense to give it back.</span>
<span class="sd">        E.g. for ADF it will be output.xyz in the workdir for optimization jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;You must implement the _setup_job method in your subclass.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Job.molecule">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.molecule">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">,</span> <span class="n">plams</span><span class="o">.</span><span class="n">Atom</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">plams</span><span class="o">.</span><span class="n">Atom</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a molecule to this calculation in various formats.</span>
<span class="sd">        If the molecule has a populated ``{mol}.flags.charge``, ``{mol}.flags.spin_polarization``</span>
<span class="sd">        or ``{mol}.flags.solvent`` object. This method will automatically try to apply them to this</span>
<span class="sd">        job.</span>

<span class="sd">        Args:</span>
<span class="sd">            mol: the molecule to read, can be a path (str). </span>
<span class="sd">                If the path exists already we read it. If it does not exist yet, </span>
<span class="sd">                it will be read in later. mol can also be a ``plams.Molecule`` object </span>
<span class="sd">                or a single ``plams.Atom`` object or a list of ``plams.Atom`` objects.</span>

<span class="sd">        Examples:</span>
<span class="sd">            </span>
<span class="sd">            .. tabs::</span>

<span class="sd">                .. group-tab:: Job script</span>

<span class="sd">                    .. code-block::</span>

<span class="sd">                        import tcutility</span>

<span class="sd">                        with tcutility.jobs.ADFJob() as job:</span>
<span class="sd">                            job.molecule(&#39;example.xyz&#39;)</span>
<span class="sd">                            job.charge(1)</span>
<span class="sd">                            job.spin_polarization(-1)</span>
<span class="sd">                            job.solvent(&#39;water&#39;)</span>

<span class="sd">                .. group-tab:: example.xyz</span>

<span class="sd">                    .. code-block::</span>

<span class="sd">                        8</span>

<span class="sd">                        N       0.00000000       0.00000000      -0.81474153</span>
<span class="sd">                        B      -0.00000000      -0.00000000       0.83567034</span>
<span class="sd">                        H       0.47608351      -0.82460084      -1.14410295</span>
<span class="sd">                        H       0.47608351       0.82460084      -1.14410295</span>
<span class="sd">                        H      -0.95216703       0.00000000      -1.14410295</span>
<span class="sd">                        H      -0.58149793       1.00718395       1.13712667</span>
<span class="sd">                        H      -0.58149793      -1.00718395       1.13712667</span>
<span class="sd">                        H       1.16299585      -0.00000000       1.13712667</span>

<span class="sd">            This is equivalent to </span>

<span class="sd">            .. tabs::</span>

<span class="sd">                .. group-tab:: Job script</span>

<span class="sd">                    .. code-block::</span>

<span class="sd">                        import tcutility</span>

<span class="sd">                        with tcutility.jobs.ADFJob() as job:</span>
<span class="sd">                            job.molecule(&#39;example2.xyz&#39;)</span>


<span class="sd">                .. group-tab:: example2.xyz</span>

<span class="sd">                    .. code-block::</span>

<span class="sd">                        8</span>

<span class="sd">                        N       0.00000000       0.00000000      -0.81474153</span>
<span class="sd">                        B      -0.00000000      -0.00000000       0.83567034</span>
<span class="sd">                        H       0.47608351      -0.82460084      -1.14410295</span>
<span class="sd">                        H       0.47608351       0.82460084      -1.14410295</span>
<span class="sd">                        H      -0.95216703       0.00000000      -1.14410295</span>
<span class="sd">                        H      -0.58149793       1.00718395       1.13712667</span>
<span class="sd">                        H      -0.58149793      -1.00718395       1.13712667</span>
<span class="sd">                        H       1.16299585      -0.00000000       1.13712667</span>

<span class="sd">                        charge = 1</span>
<span class="sd">                        spin_polarization = -1</span>
<span class="sd">                        solvent = water</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="n">mol</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_molecule_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plams</span><span class="o">.</span><span class="n">Atom</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">()</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">plams</span><span class="o">.</span><span class="n">Atom</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="c1"># check for settings in the molecule</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">spin_polarization</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;spin_polarization&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spin_polarization</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">solvent</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;solvent&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">solvent</span><span class="p">)</span></div>



<div class="viewcode-block" id="Job.copy">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make and return a copy of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

        <span class="n">cp</span> <span class="o">=</span> <span class="n">Job</span><span class="p">()</span>
        <span class="c1"># cast this object to a list of keys and values</span>
        <span class="n">lsts</span> <span class="o">=</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">dict_to_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="c1"># copy everthing in the lists</span>
        <span class="n">lsts</span> <span class="o">=</span> <span class="p">[[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span> <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">lsts</span><span class="p">]</span>
        <span class="c1"># and return a new result object</span>
        <span class="n">cp</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">dictfunc</span><span class="o">.</span><span class="n">list_to_dict</span><span class="p">(</span><span class="n">lsts</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">cp</span></div>


<div class="viewcode-block" id="Job.add_server">
<a class="viewcode-back" href="../../../api/tcutility.job.html#tcutility.job.generic.Job.add_server">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="n">connect</span><span class="o">.</span><span class="n">Server</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a server to connect to and run the calculation on.</span>
<span class="sd">        Job statuses will also be checked on the server.</span>

<span class="sd">        Args:</span>
<span class="sd">            server: the server to connect to.</span>
<span class="sd">            weight: how much weight is given to selecting this server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">connect</span><span class="o">.</span><span class="n">Local</span><span class="p">)</span> <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_servers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_servers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_weights</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, TheoCheM VU Amsterdam.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>
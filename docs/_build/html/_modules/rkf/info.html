
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rkf.info &#8212; TCutility 0.0.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=0408d661"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/rkf/info';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">TCutility 0.0.3 documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../rkf.html">
                        rkf package
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../rkf.html">
                        rkf package
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../rkf.html" class="nav-link">rkf</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">rkf.info</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for rkf.info</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module provides basic and general information about calculations done using AMS given a calculation directory. This includes information about the engine used (ADF, DFTB, BAND, ...), general information such as timings, files, status of the calculation, ... This information is used in further analysis programs.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">yutility</span> <span class="kn">import</span> <span class="n">dictfunc</span>
<span class="kn">from</span> <span class="nn">scm</span> <span class="kn">import</span> <span class="n">plams</span>
<span class="kn">from</span> <span class="nn">TCutility.rkf</span> <span class="kn">import</span> <span class="n">cache</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">j</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>


<div class="viewcode-block" id="get_calc_files"><a class="viewcode-back" href="../../rkf.html#rkf.info.get_calc_files">[docs]</a><span class="k">def</span> <span class="nf">get_calc_files</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function that returns files relevant to AMS calculations stored in calc_dir.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_dir: path pointing to the desired calculation</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing filenames and paths</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># collect all files in the current directory and subdirectories</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files_</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">):</span>
        <span class="c1"># some results are stored in dirs called {name}.results, if the calculations uses fragments there will be additional dirs called</span>
        <span class="c1"># {name}.{fragname}.results, which do not contain new information as the required info is copied over to {name}.results. Therefore</span>
        <span class="c1"># we should skip the fragment directories </span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.results&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># we only need the rkf files in the .results directories</span>
        <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.rkf&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;.results&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># opened files end in ~ and should be ignored</span>
        <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># t21 files for specific atoms are not usefull and should be ignored</span>
        <span class="k">if</span> <span class="s1">&#39;t21.&#39;</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># if a calculation is running or did not finish correctly there might be tmp. dirs, which should be ignored</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;tmp.&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># the rest can all be stored</span>
        <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">j</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files_</span><span class="p">])</span>

    <span class="c1"># parse the filenames</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="c1"># rkf files are either called /{program}.rkf, or /{name}.{program}.rkf, so we must parse them in a special way</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.rkf&#39;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">.rkf&#39;</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># logfiles are generally called either {name}.log or {name}.logfile</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.logfile&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.err&#39;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;logfile&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="get_ams_version"><a class="viewcode-back" href="../../rkf.html#rkf.info.get_ams_version">[docs]</a><span class="k">def</span> <span class="nf">get_ams_version</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to get the AMS version used in the calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_dir: path pointing to the desired calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing results about the AMS version:</span>

<span class="sd">            - **string (str)** – the full version string as written by SCM.</span>
<span class="sd">            - **major (str)** – major AMS version, should correspond to the year of release.</span>
<span class="sd">            - **minor (str)** – minor AMS version.</span>
<span class="sd">            - **micro (str)** – micro AMS version, should correspond to the internal revision number.</span>
<span class="sd">            - **date (datetime.datetime)** – date the AMS version was released.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_calc_files</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
    <span class="n">reader_ams</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ams.rkf&#39;</span><span class="p">])</span>

    <span class="c1"># store information about the version of AMS</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">)</span>
    <span class="c1"># decompose the version string</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">micro</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="get_timing"><a class="viewcode-back" href="../../rkf.html#rkf.info.get_timing">[docs]</a><span class="k">def</span> <span class="nf">get_timing</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to get the timings from the calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_dir: path pointing to the desired calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing results about the timings:</span>

<span class="sd">            - **cpu (float)** – time spent performing calculations on the cpu.</span>
<span class="sd">            - **sys (float)** – time spent by the system (file IO, process creation/destruction, etc ...).</span>
<span class="sd">            - **total (float)** – total time spent by AMS on the calculation, can be larger than the sum of cpu and sys.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_calc_files</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
    <span class="n">reader_ams</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ams.rkf&#39;</span><span class="p">])</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;CPUTime&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;CPUTime&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">sys</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;SysTime&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;SysTime&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;ElapsedTime&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;ElapsedTime&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="get_calc_info"><a class="viewcode-back" href="../../rkf.html#rkf.info.get_calc_info">[docs]</a><span class="k">def</span> <span class="nf">get_calc_info</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function to read useful info about the calculation in calc_dir. Returned information will depend on the type of file that is provided.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_dir: path pointing to the desired calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing results about the calculation and AMS:</span>

<span class="sd">            - **ret.ams_version (dict)** – information about the AMS version used, includes ``string`` the full version string and ``major``, ``minor``, ``micro``, and ``date`` which is the decomposed version.</span>
<span class="sd">            - **ret.engine (str)** – the engine that was used to perform the calculation.</span>
<span class="sd">            - **ret.job_id (str)** - the ID of the job, can be used to check if two calculations are the same. Might also be used as a unique identifier for the calculation.</span>
<span class="sd">            - </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">get_calc_files</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
    <span class="n">reader_ams</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ams.rkf&#39;</span><span class="p">])</span>

    <span class="c1"># check what the program is first. The program can be either AMS or one of the engines (ADF, DFTB, ...)</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;engine&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;engine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># if program cannot be read from reader it is probably an old version of ADF, so we should default to ADF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;adf&#39;</span>

    <span class="c1"># store the job id, which should be unique for the job</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;jobid&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;jobid&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># store information about the version of AMS</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">ams_version</span> <span class="o">=</span> <span class="n">get_ams_version</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>

    <span class="c1"># store the computation timings, only available in ams.rkf</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="n">get_timing</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>

    <span class="c1"># store the calculation status</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">calculation_status</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>

    <span class="c1"># check if this was a multijob</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">is_multijob</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.rkf&#39;</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">is_multijob</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># read molecules</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">molecule</span> <span class="o">=</span> <span class="n">get_molecules</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>

    <span class="c1"># and history variables</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">get_history</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>

    <span class="n">cache</span><span class="o">.</span><span class="n">unload</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ams.rkf&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="calculation_status"><a class="viewcode-back" href="../../rkf.html#rkf.info.calculation_status">[docs]</a><span class="k">def</span> <span class="nf">calculation_status</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function that returns the status of the calculation described in reader. </span>
<span class="sd">    In case of non-succes it will also give possible reasons for the errors/warnings.</span>

<span class="sd">    Args:</span>
<span class="sd">        reader: ``plams.KFReader`` or ``plams.KFFile`` object pointing to the desired calculation</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing information about the calculation status:</span>

<span class="sd">            - **fatal (bool)** – True if calculation cannot be analysed correctly, False otherwise</span>
<span class="sd">            - **reasons (list[str])** – list of reasons to explain the status, they can be errors, warnings, etc.</span>
<span class="sd">            - **name (str)** – calculation status written as a string, one of (&quot;SUCCESS&quot;, &quot;RUNNING&quot;, &quot;UNKNOWN&quot;, &quot;SUCCESS(W)&quot;, &quot;FAILED&quot;)</span>
<span class="sd">            - **code (str)** – calculation status written as a single character, one of (&quot;S&quot;, &quot;R&quot;, &quot;U&quot;, &quot;W&quot; &quot;F&quot;)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_calc_files</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
    <span class="n">reader_ams</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ams.rkf&#39;</span><span class="p">])</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">fatal</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">reasons</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">termination_status</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;termination status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># parse the logfile to find errors and warnings</span>
    <span class="k">if</span> <span class="s1">&#39;log&#39;</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">logfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="c1"># the first 25 characters include the timestamp and two spaces</span>
                <span class="n">line_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">25</span><span class="p">:]</span>
                <span class="c1"># errors and warnings have a predictable format</span>
                <span class="k">if</span> <span class="n">line_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;error:&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;warning: &#39;</span><span class="p">):</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">termination_status</span> <span class="o">==</span> <span class="s1">&#39;NORMAL TERMINATION&#39;</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">fatal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SUCCESS&#39;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;S&#39;</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">if</span> <span class="n">termination_status</span> <span class="o">==</span> <span class="s1">&#39;IN PROGRESS&#39;</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Calculation in progress&#39;</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;RUNNING&#39;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">if</span> <span class="n">termination_status</span> <span class="o">==</span> <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Calculation status unknown&#39;</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;UNKNOWN&#39;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">if</span> <span class="n">termination_status</span> <span class="o">==</span> <span class="s1">&#39;NORMAL TERMINATION with warnings&#39;</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">fatal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SUCCESS(W)&#39;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">if</span> <span class="n">termination_status</span> <span class="o">==</span> <span class="s1">&#39;NORMAL TERMINATION with errors&#39;</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FAILED&#39;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># if we have not excited the function yet we do not know what the status is</span>
    <span class="c1"># probably means that there was a parsing error in ams, which will be placed in termination status</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">termination_status</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;UNKNOWN&#39;</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="get_molecules"><a class="viewcode-back" href="../../rkf.html#rkf.info.get_molecules">[docs]</a><span class="k">def</span> <span class="nf">get_molecules</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to get molecules from the calculation, including input, output and history molecules.</span>
<span class="sd">    It will also add bonds to the molecule if they are given in the rkf file, else it will guess them.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_dir: path pointing to the desired calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing information about the molecular systems:</span>

<span class="sd">            - **number_of_atoms (int)** – number of atoms in the molecule.</span>
<span class="sd">            - **atom_numbers (list[int])** – list of atomic numbers for each atom in the molecule.</span>
<span class="sd">            - **atom_symbols (list[str])** – list of elements for each atom in the molecule.</span>
<span class="sd">            - **atom_masses (list[float])** – list of atomic masses for each atom in the molecule.</span>
<span class="sd">            - **input (plams.Molecule)** – molecule that was given in the input for the calculation.</span>
<span class="sd">            - **output (plams.Molecule)** – final molecule that was given as the output for the calculation. If the calculation was a singlepoint calculation output and input molecules will be the same.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_calc_files</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
    <span class="c1"># all info is stored in reader_ams</span>
    <span class="n">reader_ams</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ams.rkf&#39;</span><span class="p">])</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>

    <span class="c1"># read general</span>
    <span class="n">atnums</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;AtomicNumbers&#39;</span><span class="p">)</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atnums</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">=</span> <span class="n">natoms</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">atom_numbers</span> <span class="o">=</span> <span class="n">atnums</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">atom_symbols</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;AtomSymbols&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">atom_masses</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;AtomMasses&#39;</span><span class="p">)</span>

    <span class="c1"># read input molecule</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">()</span>
    <span class="c1"># read in the coordinates, they are given in Bohr, so convert them to Angstrom</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;Coords&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.529177</span>
    <span class="c1"># add the atoms to the molecule</span>
    <span class="k">for</span> <span class="n">atnum</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atnums</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">plams</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">atnum</span><span class="o">=</span><span class="n">atnum</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coord</span><span class="p">))</span>
    <span class="c1"># try to add the bonds if they were given in the rkf file</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;fromAtoms&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;toAtoms&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;bondOrders&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">at1</span><span class="p">,</span> <span class="n">at2</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;fromAtoms&#39;</span><span class="p">),</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;toAtoms&#39;</span><span class="p">),</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;bondOrders&#39;</span><span class="p">)):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">add_bond</span><span class="p">(</span><span class="n">plams</span><span class="o">.</span><span class="n">Bond</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">at1</span><span class="p">],</span> <span class="n">ret</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">at2</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">))</span>
    <span class="c1"># if the bonds were not given, guess them</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">guess_bonds</span><span class="p">()</span>

    <span class="c1"># read output molecule</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">()</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;Coords&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.529177</span>
    <span class="k">for</span> <span class="n">atnum</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atnums</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">plams</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">atnum</span><span class="o">=</span><span class="n">atnum</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coord</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;fromAtoms&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;toAtoms&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;bondOrders&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">at1</span><span class="p">,</span> <span class="n">at2</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;fromAtoms&#39;</span><span class="p">),</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;toAtoms&#39;</span><span class="p">),</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;bondOrders&#39;</span><span class="p">)):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">add_bond</span><span class="p">(</span><span class="n">plams</span><span class="o">.</span><span class="n">Bond</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">at1</span><span class="p">],</span> <span class="n">ret</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">at2</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">guess_bonds</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="get_history"><a class="viewcode-back" href="../../rkf.html#rkf.info.get_history">[docs]</a><span class="k">def</span> <span class="nf">get_history</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to get history variables. The type of variables read depends on the type of calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_dir: path pointing to the desired calculation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing information about the calculation status:</span>

<span class="sd">            - **number_of_entries (int)** – number of steps in the history.</span>
<span class="sd">            - **{variable} (list[Any])** – variable read from the history section. The number of variables and type of variables depend on the nature of the calculation.</span>
<span class="sd">              </span>
<span class="sd">              Common variables:</span>
<span class="sd">            - **coords (list[plams.Molecule])** – list of molecules from the history, for example from a geometry optimization or PES scan.</span>
<span class="sd">            - **energy (list[float])** – list of energies associated with each geometry step.</span>
<span class="sd">            - **gradient (list[list[float]])** – array of gradients for each geometry step and each atom.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># read history mols</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_calc_files</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">)</span>
    <span class="c1"># all info is stored in reader_ams</span>
    <span class="n">reader_ams</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;ams.rkf&#39;</span><span class="p">])</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">dictfunc</span><span class="o">.</span><span class="n">DotDict</span><span class="p">()</span>

    <span class="c1"># read general</span>
    <span class="n">atnums</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;InputMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;AtomicNumbers&#39;</span><span class="p">)</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atnums</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;History&#39;</span><span class="p">,</span> <span class="s1">&#39;nEntries&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reader_ams</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">number_of_entries</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;History&#39;</span><span class="p">,</span> <span class="s1">&#39;nEntries&#39;</span><span class="p">)</span>
        <span class="c1"># for history we read the other items in the rkf file</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">item_name</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;History&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;ItemName(</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">number_of_entries</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">reader_ams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;History&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;Coords&#39;</span><span class="p">:</span>
                    <span class="n">mol</span> <span class="o">=</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">()</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.529177</span>
                    <span class="k">for</span> <span class="n">atnum</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atnums</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
                        <span class="n">mol</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">plams</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">atnum</span><span class="o">=</span><span class="n">atnum</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coord</span><span class="p">))</span>
                    <span class="n">mol</span><span class="o">.</span><span class="n">guess_bonds</span><span class="p">()</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, TheoCheM VU Amsterdam.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>